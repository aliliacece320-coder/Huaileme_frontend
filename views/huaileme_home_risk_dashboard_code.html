<!DOCTYPE html>
<html lang="zh-CN"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>坏了么 首页风险看板 (圆体中文版)</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&amp;family=Noto+Sans+SC:wght@400;500;700;900&amp;family=ZCOOL+KuaiLe&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script id="tailwind-config">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec80", // 薄荷绿
                        "accent-coral": "#ff6b6b", // 珊瑚橙
                        "background-light": "#f8fdfb",
                        "surface-card": "rgba(255, 255, 255, 0.8)",
                    },
                    fontFamily: {
                        "display": ["Quicksand", "Noto Sans SC", "sans-serif"],
                        "cute": ["ZCOOL KuaiLe", "Noto Sans SC", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.75rem", "lg": "1.25rem", "xl": "1.75rem", "full": "9999px" },
                },
            },
        }
    </script>
<style type="text/tailwindcss">
        @layer base {
            body {
                @apply font-display text-slate-800 antialiased;font-family: "Quicksand", "Noto Sans SC", "Microsoft YaHei UI", sans-serif;
            }
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 8px 32px -8px rgba(0, 0, 0, 0.04);
        }
        .progress-bar-glow {
            box-shadow: 0 0 12px rgba(19, 236, 128, 0.3);
        }
        .coral-glow {
            box-shadow: 0 12px 40px -6px rgba(255, 107, 107, 0.15);
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .title-rounded {
            font-family: "ZCOOL KuaiLe", cursive;
        }
    </style>
<style>
        body {
            min-height: max(884px, 100dvh);
            background: radial-gradient(circle at top right, #f0fff4, transparent), 
                        radial-gradient(circle at bottom left, #fff5f5, transparent),
                        #f8fdfb;
        }
    </style>
<style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
  </head>
<body class="min-h-screen pb-40" onload="initApp()">
<script src="/public/api-client.js"></script>
<script>
const API_BASE_URL = window.location.origin + '/api';
let currentLocation = '全部物品';
let currentFoods = [];

// 全局初始化函数
window.initApp = async function() {
  console.log('=== 应用初始化开始 ===');
  console.log('ApiClient 是否存在:', typeof ApiClient !== 'undefined');
  
  // 等待DOM完全加载
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', startInit);
  } else {
    startInit();
  }
};

async function startInit() {
  console.log('开始初始化应用...');
  try {
    await loadStats();
    await loadRiskFoods();
    setupEventListeners();
    showToast('数据加载成功！', 'success');
    console.log('=== 初始化完成 ===');
  } catch (error) {
    console.error('初始化失败:', error);
    showToast('初始化失败: ' + error.message, 'error');
  }
}

// 页面加载时也执行
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initApp);
} else {
  initApp();
}

// 加载统计数据
async function loadStats() {
  try {
    console.log('开始加载统计数据...');
    const stats = await ApiClient.getFoodStats();
    console.log('统计数据:', stats);
    const urgentEl = document.querySelector('#urgent-count');
    const freshEl = document.querySelector('#fresh-count');
    if (urgentEl) urgentEl.textContent = stats.urgent_count || 0;
    if (freshEl) freshEl.textContent = stats.fresh_count || 0;
  } catch (error) {
    console.error('加载统计失败:', error);
    showToast('加载统计失败: ' + error.message, 'error');
  }
}

// 加载风险食物列表
async function loadRiskFoods() {
  try {
    console.log('开始加载风险食物...');
    const foods = await ApiClient.getRiskFoods();
    console.log('获取到食物数量:', foods.length);
    currentFoods = foods;
    renderRiskFoods(foods);
  } catch (error) {
    console.error('加载食物失败:', error);
    showToast('加载食物失败: ' + error.message, 'error');
  }
}

// 渲染风险食物列表
function renderRiskFoods(foods) {
  const container = document.querySelector('#risk-foods-container');
  if (!container) {
    console.error('找不到容器 #risk-foods-container');
    return;
  }
  
  if (foods.length === 0) {
    container.innerHTML = '<p class="text-center text-slate-400 py-8">暂无食物数据</p>';
    return;
  }
  
  container.innerHTML = foods.map(food => {
    const daysLeft = food.days_left || 0;
    const freshness = food.freshness_percentage || 0;
    let riskLevel = 'low';
    let riskColor = 'primary';
    let riskText = '挺新鲜的';
    let borderClass = '';
    
    if (daysLeft < 0 || freshness < 20) {
      riskLevel = 'critical';
      riskColor = 'accent-coral';
      riskText = '快坏了！';
      borderClass = 'coral-glow relative overflow-hidden border-l-[6px] border-l-accent-coral/60';
    } else if (daysLeft < 3 || freshness < 50) {
      riskLevel = 'high';
      riskColor = 'orange-400';
      riskText = '建议快吃';
    }
    
    const bgColorClass = riskColor === 'accent-coral' ? 'bg-accent-coral' : 
                        riskColor === 'orange-400' ? 'bg-orange-400' : 'bg-primary';
    const textColorClass = riskColor === 'accent-coral' ? 'text-accent-coral' : 
                          riskColor === 'orange-400' ? 'text-orange-400' : 'text-primary';
    
    return `
      <div class="glass-card rounded-3xl p-4 flex gap-4 ${borderClass} cursor-pointer hover:scale-[1.02] transition-transform" onclick="alert('点击了食物: ${food.name}'); window.goToFoodDetail('${food.id}');" style="cursor: pointer; user-select: none;">
        <div class="w-22 h-22 rounded-2xl bg-cover bg-center shrink-0 border border-white shadow-sm" style="background-image: url('${food.image_url || 'https://via.placeholder.com/100'}');"></div>
        <div class="flex flex-col flex-1 justify-between py-1">
          <div>
            <div class="flex justify-between items-start">
              <h4 class="font-bold text-base text-slate-900">${food.name}</h4>
              <span class="${textColorClass} text-[10px] font-black px-2 py-0.5 rounded-lg ${bgColorClass}/15">${riskText}</span>
            </div>
            <div class="flex items-center gap-1.5 text-slate-400 text-xs mt-1.5">
              <span class="material-symbols-outlined text-[16px]">location_on</span>
              <span class="font-bold">${food.storage_location} • ${food.category || '未分类'}</span>
            </div>
          </div>
          <div class="mt-3">
            <div class="flex justify-between items-end mb-1.5">
              <span class="text-sm font-black ${textColorClass}">还能放 ${daysLeft > 0 ? daysLeft : 0} 天</span>
              <span class="text-[10px] text-slate-400 font-black">${freshness}% 新鲜度</span>
            </div>
            <div class="w-full bg-slate-100 h-2.5 rounded-full overflow-hidden">
              <div class="${bgColorClass} h-full rounded-full ${riskLevel === 'low' ? 'progress-bar-glow' : ''}" style="width: ${freshness}%"></div>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// 设置事件监听
function setupEventListeners() {
  console.log('开始设置事件监听器...');
  
  // 搜索功能
  const searchInput = document.getElementById('search-input');
  console.log('搜索输入框:', searchInput);
  if (searchInput) {
    // 添加oninput作为备用
    searchInput.oninput = function(e) {
      console.log('搜索输入 (oninput):', e.target.value);
      clearTimeout(this.searchTimeout);
      this.searchTimeout = setTimeout(async () => {
        const keyword = e.target.value.trim();
        if (keyword) {
          await searchFoods(keyword);
        } else {
          await loadRiskFoods();
        }
      }, 300);
    };
    
    // 同时使用addEventListener
    let searchTimeout;
    searchInput.addEventListener('input', (e) => {
      console.log('搜索输入 (addEventListener):', e.target.value);
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(async () => {
        const keyword = e.target.value.trim();
        if (keyword) {
          await searchFoods(keyword);
        } else {
          await loadRiskFoods();
        }
      }, 300);
    });
    console.log('搜索事件监听器已绑定');
  } else {
    console.error('找不到搜索输入框！');
  }

  // 区域筛选
  const locationFilters = document.querySelectorAll('.location-filter');
  console.log('找到区域筛选按钮:', locationFilters.length);
  locationFilters.forEach((btn, index) => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      console.log('点击区域筛选:', index, btn.textContent);
      
      // 更新选中状态
      document.querySelectorAll('.location-filter').forEach(b => {
        b.classList.remove('bg-primary', 'text-white', 'shadow-lg', 'shadow-primary/30');
        const p = b.querySelector('p');
        const icon = b.querySelector('.material-symbols-outlined');
        if (p) {
          p.classList.remove('text-white');
          p.classList.add('text-slate-600');
        }
        if (icon) {
          icon.classList.remove('text-white');
          icon.classList.add('text-slate-400');
        }
        b.classList.add('bg-white', 'shadow-sm');
      });
      
      btn.classList.remove('bg-white', 'shadow-sm');
      btn.classList.add('bg-primary', 'text-white', 'shadow-lg', 'shadow-primary/30');
      
      const p = btn.querySelector('p');
      const icon = btn.querySelector('.material-symbols-outlined');
      if (p) {
        p.classList.remove('text-slate-600');
        p.classList.add('text-white');
      }
      if (icon) {
        icon.classList.remove('text-slate-400');
        icon.classList.add('text-white');
      }
      
      const locationText = btn.querySelector('p')?.textContent.trim() || btn.textContent.trim();
      currentLocation = locationText;
      console.log('筛选位置:', currentLocation);
      await filterByLocation(currentLocation);
    });
    console.log('区域筛选事件监听器已绑定:', index);
  });

  // 底部导航
  const navStats = document.querySelector('#nav-stats');
  console.log('统计导航按钮:', navStats);
  if (navStats) {
    navStats.addEventListener('click', (e) => {
      e.preventDefault();
      console.log('跳转到统计页面');
      window.location.href = 'zero_waste_statistics_report_code.html';
    });
    console.log('统计导航事件已绑定');
  } else {
    console.error('找不到统计导航按钮！');
  }
  
  const navScanner = document.querySelector('#nav-scanner');
  console.log('扫码导航按钮:', navScanner);
  if (navScanner) {
    navScanner.addEventListener('click', (e) => {
      e.preventDefault();
      console.log('跳转到扫码页面');
      window.location.href = 'ai_smart_scanner_entry_code.html';
    });
    console.log('扫码导航事件已绑定');
  } else {
    console.error('找不到扫码导航按钮！');
  }
  
  const navRecipes = document.querySelector('#nav-recipes');
  console.log('菜谱导航按钮:', navRecipes);
  if (navRecipes) {
    navRecipes.addEventListener('click', (e) => {
      e.preventDefault();
      console.log('跳转到菜谱页面');
      window.location.href = 'ai_fridge_clearing_recipes_code.html';
    });
    console.log('菜谱导航事件已绑定');
  } else {
    console.error('找不到菜谱导航按钮！');
  }
  
  console.log('所有事件监听器设置完成');
}

// 搜索食物
async function searchFoods(keyword) {
  try {
    const foods = await ApiClient.getFoods({ keyword, status: 'active' });
    currentFoods = foods;
    renderRiskFoods(foods);
    showToast(`找到 ${foods.length} 个结果`, 'info');
  } catch (error) {
    console.error('搜索失败:', error);
    showToast('搜索失败', 'error');
  }
}

// 按区域筛选
async function filterByLocation(location) {
  try {
    let storageStatus;
    if (location === '冷藏室') storageStatus = 'fridge';
    else if (location === '冷冻室') storageStatus = 'freezer';
    else if (location === '储藏柜') storageStatus = 'room';

    const params = location === '全部物品'
      ? { status: 'active' }
      : { status: 'active', storageStatus };

    const foods = await ApiClient.getFoods(params);
    currentFoods = foods;
    renderRiskFoods(foods);
    showToast(`已筛选：${location}`, 'info');
  } catch (error) {
    console.error('筛选失败:', error);
    showToast('筛选失败', 'error');
  }
}

// 跳转到食物详情（全局函数，供onclick调用）
window.goToFoodDetail = function(foodId) {
  console.log('跳转到食物详情:', foodId);
  window.location.href = `item_details_action_screen_code.html?id=${foodId}`;
};

// 区域筛选处理函数（全局，供onclick调用）
window.handleLocationFilter = async function(location, element) {
  console.log('点击区域筛选:', location);
  
  // 更新选中状态
  document.querySelectorAll('.location-filter').forEach(b => {
    b.classList.remove('bg-primary', 'text-white', 'shadow-lg', 'shadow-primary/30');
    const p = b.querySelector('p');
    const icon = b.querySelector('.material-symbols-outlined');
    if (p && !p.textContent.includes('全部物品')) {
      p.classList.remove('text-white');
      p.classList.add('text-slate-600');
    }
    if (icon) {
      icon.classList.remove('text-white');
      icon.classList.add('text-slate-400');
    }
    b.classList.add('bg-white', 'shadow-sm');
  });
  
  element.classList.remove('bg-white', 'shadow-sm');
  element.classList.add('bg-primary', 'text-white', 'shadow-lg', 'shadow-primary/30');
  
  const p = element.querySelector('p');
  const icon = element.querySelector('.material-symbols-outlined');
  if (p) {
    p.classList.remove('text-slate-600');
    p.classList.add('text-white');
  }
  if (icon) {
    icon.classList.remove('text-slate-400');
    icon.classList.add('text-white');
  }
  
  currentLocation = location;
  await filterByLocation(currentLocation);
};

// 显示提示消息
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `fixed top-20 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 rounded-full text-white text-sm font-bold shadow-lg transition-all transform translate-y-0 opacity-100`;
  
  const colors = {
    success: 'bg-primary',
    error: 'bg-accent-coral',
    info: 'bg-blue-500'
  };
  
  toast.classList.add(colors[type] || colors.info);
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.transform = 'translateY(-20px)';
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 300);
  }, 2000);
}
</script>
<div class="sticky top-0 z-50 bg-white/60 backdrop-blur-xl border-b border-white/20">
<div class="flex items-center p-5 pb-3 justify-between">
<div class="flex size-11 shrink-0 items-center justify-center rounded-2xl bg-primary/20 text-primary">
<span class="material-symbols-outlined font-bold text-2xl">eco</span>
</div>
<h2 class="text-2xl font-black title-rounded flex-1 ml-4 text-slate-900 tracking-wide">快过期啦</h2>
<div class="flex gap-2">
<div class="size-11 rounded-full bg-cover bg-center border-2 border-white shadow-md" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDJA-qq50001FMFD4UAXt3BcLpC2G7NSWTHbtUIxJ6L8pBb8sZmzqUTnrsDk_jupjp_9HxpMSrmplXsL6Ci8gtGuJwGUrHR6qI0bCQEHJs8A2RckS0fqh_B35ftoUqK33aOD8clPw_412RnuX7-LhU-tV9y3SVx1m5HL5MWFMYN-dXduN6XR36bHKKQ5vg26Ljw-oEz43GqNitnjpFOHvWB2CCxSp9G3u5jxGPwxIsfTrVy1ONSL_Wxzu8DLg3c3SMSD_71hnm0Mv2L");'>
</div>
</div>
</div>
<div class="px-5 py-3 pt-0">
<div class="relative flex items-center group">
<span class="material-symbols-outlined absolute left-4 text-slate-400 text-xl transition-colors group-focus-within:text-primary">search</span>
<input id="search-input" class="w-full bg-slate-100/60 border-none rounded-2xl py-3 pl-11 pr-4 text-sm focus:ring-4 focus:ring-primary/10 placeholder:text-slate-400 transition-all" placeholder="找找冰箱里有什么？" type="text"/>
</div>
</div>
</div>
<div class="px-5 py-4">
<div class="flex gap-4">
<div class="flex flex-1 flex-col gap-1 rounded-3xl p-5 bg-white/80 border border-slate-50 shadow-sm">
<div class="flex items-center gap-2">
<span class="material-symbols-outlined text-accent-coral text-[20px] fill-1">warning</span>
<p class="text-accent-coral text-[11px] font-black tracking-widest">急需消灭</p>
</div>
<p id="urgent-count" class="text-3xl font-black leading-tight mt-1 text-slate-900">0</p>
<p class="text-slate-400 text-xs font-bold">件食物告急</p>
</div>
<div class="flex flex-1 flex-col gap-1 rounded-3xl p-5 bg-white/80 border border-slate-50 shadow-sm">
<div class="flex items-center gap-2">
<span class="material-symbols-outlined text-primary text-[20px] fill-1">check_circle</span>
<p class="text-primary text-[11px] font-black tracking-widest">状态新鲜</p>
</div>
<p id="fresh-count" class="text-3xl font-black leading-tight mt-1 text-slate-900">0</p>
<p class="text-slate-400 text-xs font-bold">件还能再放放</p>
</div>
</div>
</div>
<div class="flex gap-3 px-5 py-2 overflow-x-auto no-scrollbar">
<div class="location-filter flex h-11 shrink-0 items-center justify-center rounded-full bg-primary px-6 shadow-lg shadow-primary/30 cursor-pointer" onclick="handleLocationFilter('全部物品', this)" style="cursor: pointer;">
<p class="text-white text-sm font-bold">全部物品</p>
</div>
<div class="location-filter flex h-11 shrink-0 items-center justify-center gap-x-2 rounded-full bg-white border border-slate-100 px-5 shadow-sm cursor-pointer" onclick="handleLocationFilter('冷藏室', this)" style="cursor: pointer;">
<span class="material-symbols-outlined text-slate-400 text-[20px]">kitchen</span>
<p class="text-sm font-bold text-slate-600">冷藏室</p>
</div>
<div class="location-filter flex h-11 shrink-0 items-center justify-center gap-x-2 rounded-full bg-white border border-slate-100 px-5 shadow-sm cursor-pointer" onclick="handleLocationFilter('储藏柜', this)" style="cursor: pointer;">
<span class="material-symbols-outlined text-slate-400 text-[20px]">inventory_2</span>
<p class="text-sm font-bold text-slate-600">储藏柜</p>
</div>
<div class="location-filter flex h-11 shrink-0 items-center justify-center gap-x-2 rounded-full bg-white border border-slate-100 px-5 shadow-sm cursor-pointer" onclick="handleLocationFilter('冷冻室', this)" style="cursor: pointer;">
<span class="material-symbols-outlined text-slate-400 text-[20px]">ac_unit</span>
<p class="text-sm font-bold text-slate-600">冷冻室</p>
</div>
</div>
<div class="mt-6">
<div class="flex items-center justify-between px-6 mb-4">
<h3 class="text-xl font-black tracking-tight text-slate-900">腐败风险提醒</h3>
<span class="text-primary text-sm font-bold bg-primary/10 px-3 py-1 rounded-full">查看全部</span>
</div>
<div id="risk-foods-container" class="space-y-4 px-5">
<!-- 食物列表将通过JavaScript动态加载 -->
</div>
</div>
<div class="fixed bottom-0 left-0 w-full px-5 pb-8 bg-gradient-to-t from-background-light via-background-light/95 to-transparent pt-12 z-50">
<div class="max-w-md mx-auto relative flex items-center justify-between px-6 py-4 bg-white/80 backdrop-blur-2xl rounded-full border border-white/40 shadow-[0_20px_50px_rgba(0,0,0,0.1)]">
<div class="flex flex-col items-center gap-1 cursor-pointer" onclick="window.location.href='huaileme_home_risk_dashboard_code.html'" style="cursor: pointer;">
<span class="material-symbols-outlined text-primary font-bold fill-1">home</span>
<span class="text-[10px] font-black text-primary">首页</span>
</div>
<div id="nav-stats" class="flex flex-col items-center gap-1 text-slate-400 cursor-pointer hover:text-slate-600 transition-colors" onclick="window.location.href='zero_waste_statistics_report_code.html'" style="cursor: pointer;">
<span class="material-symbols-outlined text-[24px]">savings</span>
<span class="text-[10px] font-bold">统计</span>
</div>
<div class="absolute left-1/2 -translate-x-1/2 -top-10">
<button id="nav-scanner" class="size-16 rounded-full bg-primary text-white shadow-[0_15px_35px_rgba(19,236,128,0.5)] flex items-center justify-center border-[5px] border-white active:scale-90 transition-all duration-200" onclick="window.location.href='ai_smart_scanner_entry_code.html'" style="cursor: pointer;">
<span class="material-symbols-outlined text-3xl font-bold">qr_code_scanner</span>
</button>
<span class="absolute -bottom-7 left-1/2 -translate-x-1/2 text-[10px] font-black text-slate-400 w-max">扫一扫</span>
</div>
<div class="w-8"></div> 
<div id="nav-recipes" class="flex flex-col items-center gap-1 text-slate-400 cursor-pointer hover:text-slate-600 transition-colors" onclick="window.location.href='ai_fridge_clearing_recipes_code.html'" style="cursor: pointer;">
<span class="material-symbols-outlined text-[24px]">restaurant_menu</span>
<span class="text-[10px] font-bold">菜谱</span>
</div>
<div class="flex flex-col items-center gap-1 text-slate-400 cursor-pointer hover:text-slate-600 transition-colors" onclick="window.location.href='user_family_center_code.html'" style="cursor: pointer;">
<span class="material-symbols-outlined text-[24px]">face</span>
<span class="text-[10px] font-bold">设置</span>
</div>
</div>
</div>

</body></html>